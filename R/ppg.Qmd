---
title: "PPG"
format:
  gfm:
    toc: false
    wrap: none
params:
  tax_level: "species"
execute: 
  echo: false
  message: false
  warning: false
---

```{r}
#| label: setup
source(here::here("R/packages.R"))
source(here::here("R/functions.R"))
library(glue)
library(tidyverse)
library(assertr)
library(taxlist)
library(taxnames)
conflicted::conflict_prefer("filter", "dplyr")

tar_load(ppg)
```

```{r}
#| label: ppg-treatment
#| results: asis

higher_tax_levels_all <- c("class", "subclass", "order", "suborder", "family", "subfamily", "tribe", "subtribe", "genus")

ppg_print <-
  ppg |>
  filter(taxonRank %in% higher_tax_levels_all) |>
  filter(taxonomicStatus == "accepted") |>
  # TODO fix these in Rhakhis
  # Remove bad taxa
  filter(
    taxonID != "wfo-4000030830", # Polystichopsis (J.Sm.) Holttum, PPG I has Polystichopsis (J.Sm.) C.Chr. nolint
    taxonID != "wfo-1000070090" # Todea Bernh., PPG I has Todea Willd. ex Bernh.
  )

higher_tax_levels_used <- higher_tax_levels_all[higher_tax_levels_all %in% ppg_print$taxonRank]

priority_order <- c(
  # Class
  "Lycopodiopsida",
  "Polypodiopsida",
  # Subclass
  "Equisetidae",
  "Ophioglossidae",
  "Marattiidae",
  "Polypodiidae",
  # Order
  # (Lycopodiopsida)
  "Lycopodiales",
  "Isoetales",
  "Selaginellales",
  # (Equisetidae)
  "Equisetales",
  # (Ophioglossidae)
  "Psilotales",
  "Ophioglossales",
  # (Marattiidae)
  "Marattiales",
  # (Polypodiidae)
  "Osmundales",
  "Hymenophyllales",
  "Gleicheniales",
  "Schizaeales",
  "Salviniales",
  "Cyatheales",
  "Polypodiales"
)

ppg_tl <- ppg_print |>
  dplyr::select(
    TaxonConceptID = taxonID,
    TaxonUsageID = taxonID,
    TaxonName = scientificName,
    AuthorName = scientificNameAuthorship,
    Level = taxonRank,
    Parent = parentNameUsageID
  ) |>
  mutate(AcceptedName = TRUE) |>
  as.data.frame() |>
  df2taxlist(levels = rev(higher_tax_levels_used))

# Format headers (indents) for each taxonomic level
indent_df <-
  tibble(level = rev(levels(ppg_tl))) |>
  mutate(
    indent_num = 0:(length(levels(ppg_tl)) - 1)
  ) |>
  rowwise() |>
  mutate(
    indent = paste0(rep("#", indent_num), collapse = ""),
    indent = paste0(indent, "##", collapse = "")
  ) |>
  ungroup() |>
  # The lowest taxonomic level should not have an indent (header)
  mutate(
    indent = case_when(
      level == first(levels(ppg_tl)) ~ "",
    .default = indent
  )) |>
  select(level, indent)

ppg_tl |>
  sort_taxa(priority = priority_order) |>
  indented_list(indent = "", print = FALSE) |>
  as_tibble() |>
  select(-indent) |>
  janitor::clean_names() |>
  left_join(
    indent_df, by = "level",
    relationship = "many-to-one"
  ) |>
  mutate(
    formatted_name = case_when(
      level == "genus" ~ glue::glue("*{taxon_name}* {author_name}"),
      level != "genus" ~ glue::glue(
        "{indent} {str_to_sentence(level)} **{taxon_name}** {author_name}"
      ),
      .default = formatted_name
    ),
    formatted_name = as.character(formatted_name)
  ) |>
  pull(formatted_name) |>
  cat(sep = "\n\n")
```
